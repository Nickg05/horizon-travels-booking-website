
<!-- Nickolas Greiner Student Id: 24018357 -->

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Bookings - Horizon Travels</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}" />
  </head>
  <body>
    <!-- Navbar section -->
    <nav>
      <input type="checkbox" id="check" />
      <label for="check" class="checkbtn">
        <img src="/static/hamburger.png" alt="Menu" />
      </label>
      <label class="logo">Horizon Travels</label>
      <ul>
        <li><a class="active" href="{{ url_for('welcome') }}">Home</a></li>
        <li><a href="{{ url_for('bookings') }}">Manage Bookings</a></li>
        <li>
          <a href="{{ url_for('user_profile') }}">
            <img src="/static/user.png" alt="User Profile" style="height: 24px; vertical-align: middle;" />
          </a>
        </li>
        {% if session.get('logged_in') %}
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        {% else %}
          <li><a href="{{ url_for('login') }}">Login/Register</a></li>
        {% endif %}
      </ul>
    </nav>

    <!-- Bookings Page Content -->
    <section>
      <div class="container">
        <h1>Your Bookings</h1>
        <!-- Debug Information (Removed or Commented Out) -->
        <!-- <pre>Session Data: {{ session | tojson }}</pre>
        <pre>Bookings Data: {{ bookings | tojson }}</pre> -->
        {% if session.get('logged_in') %}
          {% if bookings %}
            <table>
              <tr>
                <th>Departure</th>
                <th>Arrival</th>
                <th>Departure Time</th>
                <th>Arrival Time</th>
                <th>Seat Type</th>
                <th>Num Seats</th>
                <th>Travel Date</th>
                <th>Total Fare (£)</th> <!-- Updated column header -->
                <th>Action</th>
              </tr>
              {% for booking in bookings %}
                <tr>
                  <td>{{ booking.departure }}</td>
                  <td>{{ booking.arrival }}</td>
                  <td>{{ booking.departure_time }}</td>
                  <td>{{ booking.arrival_time }}</td>
                  <td>{{ booking.seat_type }}</td>
                  <td>{{ booking.num_seats }}</td>
                  <td>{{ booking.travel_date }}</td>
                  <td>{{ booking.fare * booking.num_seats }}</td> <!-- Calculate total fare -->
                  <td>
                    <form action="{{ url_for('cancel_booking') }}" method="POST" style="display:inline;" onsubmit="return confirmCancellation(this);">
                      <input type="hidden" name="bookingID" value="{{ booking.bookingID }}">
                      <input type="hidden" name="fare" value="{{ booking.fare * booking.num_seats }}">
                      <input type="hidden" name="travel_date" value="{{ booking.travel_date }}">
                      <button type="submit" class="cancel-button">Cancel</button>
                    </form>
                    <a href="{{ url_for('download_ticket', booking_id=booking.bookingID) }}" class="download-button">Download Ticket</a>
                    <a href="{{ url_for('update_booking', booking_id=booking.bookingID) }}" class="update-button">Update</a>
                  </td>
                </tr>
              {% endfor %}
            </table>
          {% else %}
            <p>You have no bookings yet. Please make a booking to see your trips here.</p>
          {% endif %}
        {% else %}
          <p>Please <a href="{{ url_for('login') }}">log in</a> to view your bookings.</p>
        {% endif %}
      </div>
    </section>

    <script>
      function confirmCancellation(form) {
        const fare = parseFloat(form.querySelector('input[name="fare"]').value);
        const travelDate = new Date(form.querySelector('input[name="travel_date"]').value);
        const today = new Date();
        const daysUntilTravel = Math.ceil((travelDate - today) / (1000 * 60 * 60 * 24));

        let refundAmount = 0;
        let message = "";

        if (daysUntilTravel > 60) {
          refundAmount = fare;
          message = `Your booking will be canceled. You will receive a full refund of £${refundAmount.toFixed(2)}.`;
        } else if (daysUntilTravel > 30) {
          refundAmount = fare * 0.6; // 40% cancellation charge
          message = `Your booking will be canceled. A 40% cancellation charge applies. You will receive a refund of £${refundAmount.toFixed(2)}.`;
        } else {
          refundAmount = 0; // No refund
          message = `Your booking will be canceled. No refund is available as the cancellation is within 30 days of the travel date.`;
        }

        return confirm(message);
      }
    </script>
  </body>
</html>
