<!-- Nickolas Greiner Student Id: 24018357 -->

<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>Responsive Navbar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css')}}" />
  </head>
  <body>
    <nav>
      <input type="checkbox" id="check" />
      <label for="check" class="checkbtn">
        <img src="/static/hamburger.png" alt="Menu" />
      </label>
      <label class="logo">Horizon Travels</label>
      <ul>
        <li><a class="active" href="{{ url_for('welcome') }}">Home</a></li>
        <li><a href="{{ url_for('bookings') }}">Manage Bookings</a></li>
        <li>
          <a href="{{ url_for('user_profile') }}">
            <img src="/static/user.png" alt="User Profile" style="height: 24px; vertical-align: middle;" />
          </a>
        </li>
        {% if session.get('is_admin') %}
          <li><a href="{{ url_for('admin_bookings') }}">Admin</a></li>
        {% endif %}
        {% if session.get('logged_in') %}
          <li><a href="{{ url_for('logout') }}">Logout</a></li>
        {% else %}
          <li><a href="{{ url_for('login') }}">Login/Register</a></li>
        {% endif %}
      </ul>
    </nav>

    <!-- Welcome message -->
    {% if session.get('logged_in') %}
      <div class="welcome-message">
        <p>Welcome, {{ session['username'] }}!</p>
      </div>
    {% endif %}

    <div class="background"></div>
    <section>
      <div class="container">
        <!-- Item 2: Customer Reviews Section -->
        <div class="item-2">
          <h2>What Our Customers Say</h2>
          <blockquote>"Horizon Travels made my trip planning so easy and affordable!"<footer>- Jane Doe</footer></blockquote>
          <blockquote>"I loved the seamless experience of booking with Horizon Travels."<footer>- John Smith</footer></blockquote>
        </div>

        <!-- Dropdowns and Calendar Section -->
        <div class="dropdown-container">
          <!-- Departing From label -->
          <div class="dropdown">
            <p style="color: white;">Departing From</p>
            <select id="departure-select" class="dropdown-btn">
              <option value="" disabled selected>Select Departure</option>
              {% for departure in departures %}
                <option value="{{ departure['departure'] }}" data-departure-time="{{ departure['departure_time'] }}">
                  {{ departure['departure'] }} - {{ departure['departure_time'] }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- Arrival label -->
          <div class="dropdown">
            <p style="color: white;">Arrival</p>
            <select id="arrival-select" class="dropdown-btn" disabled>
              <option value="" disabled selected>Select Arrival</option>
              <!-- Options will be dynamically populated based on the selected departure -->
            </select>
          </div>

          <!-- Date Picker -->
          <div class="dropdown">
            <p style="color: white;">Select Date</p>
            <input type="date" id="travel-date" class="dropdown-btn" />
          </div>

          <button class="submit-btn" id="submit-btn">Submit</button>
        </div>

        <!-- Item 3: Your Trip Selection Section -->
        <div class="item-3">
          <h2>Your Trip Selection</h2>
          <p id="selected-trip"></p>

          <!-- Seat Type Dropdown added here -->
          <div id="seat-selection-container" style="display: none;">
            <label>Choose Seat Type:</label>
            <div>
              <input type="radio" id="economy" name="seat-type" value="Economy" />
              <label for="economy">Economy</label>
            </div>
            <div>
              <input type="radio" id="business" name="seat-type" value="Business" />
              <label for="business">Business</label>
            </div>

            <!-- Disclaimer for Business seat type -->
            <p style="color: red; font-size: 0.9em; margin-top: 5px;">
              * Selecting "Business" seat type will double the fare.
            </p>

            <!-- Number of Seats -->
            <label for="num-seats">Number of Seats (max 10):</label>
            <input type="number" id="num-seats" min="1" max="10" value="1" />
          </div>

          <button id="select-trip-btn" class="select-btn" style="display: none;">Select</button>
        </div>

        <!-- Trip Selection Container -->
        <div id="trip-selection-container" style="display: none;">
          <h2>Your Trip Selection</h2>
          <div id="selected-trip" class="trip-details">
            <!-- Trip details will be dynamically populated here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Payment Details Modal -->
    <div id="payment-details-modal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2 style="text-align: center; color: #3587A4;">Payment Details</h2>
        <p style="text-align: center; color: #555;">Please enter your debit card details to confirm your booking.</p>
        <form id="payment-form" style="display: flex; flex-direction: column; gap: 15px;">
          <div>
            <label for="card-number" style="font-weight: bold; color: #333;">Card Number:</label>
            <input type="text" id="card-number" maxlength="16" placeholder="Enter 16-digit card number" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;" />
          </div>
          <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
              <label for="expiry-date" style="font-weight: bold; color: #333;">Expiry Date:</label>
              <input type="month" id="expiry-date" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;" />
            </div>
            <div style="flex: 1;">
              <label for="cvv" style="font-weight: bold; color: #333;">CVV/CVC:</label>
              <input type="text" id="cvv" maxlength="3" placeholder="3-digit code" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;" />
            </div>
          </div>
          <div>
            <label for="cardholder-name" style="font-weight: bold; color: #333;">Cardholder Name:</label>
            <input type="text" id="cardholder-name" placeholder="Name as on card" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;" />
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <button id="confirm-payment-btn" type="button" style="background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Confirm Payment</button>
            <button id="cancel-payment-btn" type="button" style="background-color: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // Function to remove active class from all options
      function removeActiveClass() {
        const options = document.querySelectorAll('.dropdown-option');
        options.forEach(option => {
          option.classList.remove('active-option');
        });
      }

      // Function to set the date picker limits and disable weekends
      function setDatePickerLimit() {
        const today = new Date();
        const maxDate = new Date();

        // Set the max date to 3 months ahead
        maxDate.setMonth(today.getMonth() + 3);

        // Format the date to YYYY-MM-DD (required format for the date input)
        const formattedMaxDate = maxDate.toISOString().split('T')[0];
        const formattedToday = today.toISOString().split('T')[0];

        // Set the 'min' and 'max' attributes for the date picker
        const datePicker = document.getElementById('travel-date');
        datePicker.setAttribute('max', formattedMaxDate);
        datePicker.setAttribute('min', formattedToday);

        // Disable weekends
        datePicker.addEventListener('input', function () {
          const selectedDate = new Date(this.value);
          const day = selectedDate.getDay(); // 0 = Sunday, 6 = Saturday

          if (day === 0 || day === 6) {
            alert('Bookings are only allowed from Monday to Friday. Please select a weekday.');
            this.value = ''; // Clear the invalid date
          }
        });
      }

      // Call the function to set the date picker limits on page load
      document.addEventListener('DOMContentLoaded', setDatePickerLimit);

      // Store selected times and seat quantity
      let selectedDepartureTime = '';
      let selectedArrivalTime = '';
      let selectedArrival = '';
      let selectedDeparture = '';
      let travelDate = '';
      let selectedSeatType = '';
      let numSeats = 1;  // Default number of seats is 1

      // Add a variable to store the fare
      let journeyFare = 0;

      // Handle departure selection
      document.getElementById('departure-select').addEventListener('change', function () {
        selectedDeparture = this.value;
        selectedDepartureTime = this.options[this.selectedIndex].getAttribute('data-departure-time');
        console.log('Selected Departure:', selectedDeparture);
        console.log('Selected Departure Time:', selectedDepartureTime);

        // Fetch arrivals based on the selected departure
        fetch(`/get_arrival?departure=${selectedDeparture}`)
          .then(response => response.json())
          .then(data => {
            const arrivalSelect = document.getElementById('arrival-select');
            arrivalSelect.innerHTML = '<option value="" disabled selected>Select Arrival</option>'; // Reset options

            if (data.arrival) {
              data.arrival.forEach(arrival => {
                const option = document.createElement('option');
                option.value = arrival.arrival;
                option.textContent = `${arrival.arrival} - ${arrival.arrival_time || 'N/A'}`;
                option.setAttribute('data-arrival-time', arrival.arrival_time || 'N/A');
                arrivalSelect.appendChild(option);
              });

              arrivalSelect.disabled = false; // Enable the arrival select box
            } else {
              console.error('Error fetching arrivals:', data.error);
            }
          })
          .catch(error => {
            console.error('Error:', error);
          });
      });

      // Handle arrival selection
      document.getElementById('arrival-select').addEventListener('change', function () {
        selectedArrival = this.value;
        selectedArrivalTime = this.options[this.selectedIndex].getAttribute('data-arrival-time');
        console.log('Selected Arrival:', selectedArrival);
        console.log('Selected Arrival Time:', selectedArrivalTime);
      });

      // Update the submit button click handler to fetch the fare
      document.getElementById('submit-btn').addEventListener('click', function () {
        travelDate = document.getElementById('travel-date').value;

        // Debugging logs to check the values of variables
        console.log('Selected Departure:', selectedDeparture);
        console.log('Selected Arrival:', selectedArrival);
        console.log('Selected Departure Time:', selectedDepartureTime);
        console.log('Selected Arrival Time:', selectedArrivalTime);
        console.log('Travel Date:', travelDate);

        // Check if all fields are selected
        if (selectedDeparture && selectedArrival && selectedDepartureTime && selectedArrivalTime && travelDate) {
            // Fetch the fare for the selected journey
            fetch(`/get_fare?departure=${selectedDeparture}&arrival=${selectedArrival}`)
                .then(response => response.json())
                .then(data => {
                    if (data.fare) {
                        journeyFare = data.fare; // Store the fare
                        const tripDetails = `Departure: ${selectedDeparture} at ${selectedDepartureTime}, Arrival: ${selectedArrival} at ${selectedArrivalTime}, Date: ${travelDate}, Fare: £${journeyFare}`;
                        document.getElementById('selected-trip').textContent = tripDetails;
                        document.getElementById('select-trip-btn').style.display = 'block'; // Show the "Select" button

                        // Show seat selection dropdown after submitting the trip
                        document.getElementById('seat-selection-container').style.display = 'block';
                    } else {
                        alert('Error fetching fare: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error fetching fare.');
                });
        } else {
            alert('Please fill in all fields!');
        }
      });

      // Handle seat type selection
      document.querySelectorAll('input[name="seat-type"]').forEach((radio) => {
        radio.addEventListener('change', function () {
          selectedSeatType = this.value; // Capture the selected seat type
          console.log('Selected Seat Type:', selectedSeatType); // Debug log

          // Recalculate the fare based on the seat type
          let adjustedFare = journeyFare;
          if (selectedSeatType === 'Economy') {
            adjustedFare *= 1.2; // Add 20% extra for Economy
          } else if (selectedSeatType === 'Business') {
            adjustedFare *= 2; // Double the fare for Business
          }

          // Update the trip details with the adjusted fare
          const totalFare = adjustedFare * numSeats;
          const tripDetails = `Departure: ${selectedDeparture} at ${selectedDepartureTime}, Arrival: ${selectedArrival} at ${selectedArrivalTime}, Date: ${travelDate}, Fare: £${totalFare.toFixed(2)}`;
          document.getElementById('selected-trip').textContent = tripDetails;
        });
      });

      // Handle number of seats selection
      document.getElementById('num-seats').addEventListener('input', function () {
        numSeats = Math.min(10, Math.max(1, this.value)); // Ensure the number is between 1 and 10
        this.value = numSeats;

        // Recalculate the fare based on the number of seats and seat type
        let adjustedFare = journeyFare;
        if (selectedSeatType === 'Economy') {
          adjustedFare *= 1.2; // Add 20% extra for Economy
        } else if (selectedSeatType === 'Business') {
          adjustedFare *= 2; // Double the fare for Business
        }

        const totalFare = adjustedFare * numSeats;
        const tripDetails = `Departure: ${selectedDeparture} at ${selectedDepartureTime}, Arrival: ${selectedArrival} at ${selectedArrivalTime}, Date: ${travelDate}, Fare: £${totalFare.toFixed(2)}`;
        document.getElementById('selected-trip').textContent = tripDetails;
      });

      // Show the payment details modal
      document.getElementById('select-trip-btn').addEventListener('click', function () {
        document.getElementById('payment-details-modal').style.display = 'block';
      });

      // Handle confirm payment button click
      document.getElementById('confirm-payment-btn').addEventListener('click', function () {
        const cardNumber = document.getElementById('card-number').value;
        const expiryDate = document.getElementById('expiry-date').value;
        const cardholderName = document.getElementById('cardholder-name').value;
        const cvv = document.getElementById('cvv').value;

        if (!cardNumber || !expiryDate || !cardholderName || !cvv) {
          alert('Please fill in all payment details!');
          return;
        }

        // Include payment details in the booking data
        const bookingDetails = {
          departure: selectedDeparture,
          arrival: selectedArrival,
          departureTime: selectedDepartureTime,
          arrivalTime: selectedArrivalTime,
          travelDate: travelDate,
          seatType: selectedSeatType,
          numSeats: numSeats,
          paymentDetails: {
            cardNumber,
            expiryDate,
            cardholderName,
            cvv,
          },
        };

        // Send the booking details to the backend
        fetch('/add_booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(bookingDetails),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert('Payment successful! Booking confirmed!');
              window.location.href = '/bookings';
            } else {
              alert('Error confirming payment');
            }
          })
          .catch((error) => {
            console.error('Error:', error);
            alert('Error sending payment data.');
          });
      });

      // Handle cancel payment button click
      document.getElementById('cancel-payment-btn').addEventListener('click', function () {
        document.getElementById('payment-details-modal').style.display = 'none';
      });

      document.getElementById('seat-selection-container').style.display = 'none';
    </script>
  </body>
</html>

